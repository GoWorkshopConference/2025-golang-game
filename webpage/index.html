<!DOCTYPE html>
<html
  lang="ja"
  data-server-url="https://ebiten-ranking-523681844761.asia-northeast2.run.app"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ãˆã³ãƒ•ãƒ©ã‚¤ğŸ¦</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h1>Go ã§ä½œã£ãŸã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚²ãƒ¼ãƒ  ğŸ¤ğŸ¤ğŸ¤</h1>
    <div class="name-input-container">
      <input
        type="text"
        id="playerNameInput"
        placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›"
        maxlength="20"
      />
      <button id="saveNameButton">ä¿å­˜</button>
    </div>
    <div class="source-link">
      <a
        href="https://github.com/GoWorkshopConference/2025-golang-game"
        target="_blank"
        rel="noopener noreferrer"
      >
        ğŸ“¦ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
      </a>
    </div>
    <div class="container">
      <div id="wasmLoadingMessage" class="wasm-loading-message">
        WASMã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...
      </div>
      <iframe src="game.html" id="gameFrame"></iframe>
    </div>
    <div class="ranking-section">
      <div class="ranking-header">
        <h2>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
        <button id="refreshRankingButton">æ›´æ–°</button>
      </div>
      <div id="loadingMessage" class="loading-message">èª­ã¿è¾¼ã¿ä¸­...</div>
      <div id="errorMessage" class="error-message" style="display: none"></div>
      <div id="rankingList" class="ranking-list"></div>
    </div>
    <script type="module">
      import { initPlayerName } from "./playerName.js";
      import { initIframeStorage } from "./iframeStorage.js";
      import { initRanking } from "./ranking.js";

      const iframe = document.getElementById("gameFrame");
      const wasmLoadingMessage = document.getElementById("wasmLoadingMessage");

      // WASMèª­ã¿è¾¼ã¿çŠ¶æ…‹ã®ç›£è¦–
      iframe.addEventListener("load", () => {
        // iframeã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ãŸã‚‰ã€ã•ã‚‰ã«WASMã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
        // iframeå†…ã®windowãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã¾ã§å¾…æ©Ÿ
        const checkWasmLoaded = setInterval(() => {
          try {
            // iframeå†…ã®windowã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€WASMãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            const iframeWindow = iframe.contentWindow;
            if (
              iframeWindow &&
              iframeWindow.document.readyState === "complete"
            ) {
              // å°‘ã—é…å»¶ã•ã›ã¦ã‹ã‚‰éè¡¨ç¤ºã«ã™ã‚‹ï¼ˆWASMã®åˆæœŸåŒ–æ™‚é–“ã‚’è€ƒæ…®ï¼‰
              setTimeout(() => {
                wasmLoadingMessage.style.display = "none";
                clearInterval(checkWasmLoaded);
              }, 1000);
            }
          } catch (e) {
            // ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ã‚¨ãƒ©ãƒ¼ãªã©ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„å ´åˆã¯ã€ä¸€å®šæ™‚é–“å¾Œã«éè¡¨ç¤º
            setTimeout(() => {
              wasmLoadingMessage.style.display = "none";
              clearInterval(checkWasmLoaded);
            }, 3000);
          }
        }, 100);

        // æœ€å¤§10ç§’å¾Œã«å¼·åˆ¶çš„ã«éè¡¨ç¤ºã«ã™ã‚‹
        setTimeout(() => {
          clearInterval(checkWasmLoaded);
          wasmLoadingMessage.style.display = "none";
        }, 10000);
      });

      // å„æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
      initPlayerName(iframe);
      initIframeStorage(iframe);
      initRanking();
    </script>
  </body>
</html>
